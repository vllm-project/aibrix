apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-extension
  namespace: system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-extension
  template:
    metadata:
      labels:
        app: api-extension
    spec:
      serviceAccountName: api-extension-sa
      automountServiceAccountToken: true
      containers:
      - name: api-extension
        image: aibrix/runtime:nightly
        command: 
        - aibrix_api_extension
        - --enable-k8s-job
        ports:
        - containerPort: 8100
        resources:
          limits:
            cpu: 1
            memory: 1Gi
          requests:
            cpu: 1
            memory: 1Gi
        env:
          # Metadata store configuration
          - name: REDIS_HOST
            value: "aibrix-redis-master.aibrix-system.svc.cluster.local"
          - name: REDIS_PORT
            value: "6379"
          - name: REDIS_DB
            value: "0"
          # Object store configuration
          # Comment the following lines to disable S3 as the object store
          - name: STORAGE_AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: aibrix-s3-credentials
                key: access-key-id
          - name: STORAGE_AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: aibrix-s3-credentials
                key: secret-access-key
          - name: STORAGE_AWS_REGION
            valueFrom:
              secretKeyRef:
                name: aibrix-s3-credentials
                key: region
          - name: STORAGE_AWS_BUCKET
            valueFrom:
              secretKeyRef:
                name: aibrix-s3-credentials
                key: bucket-name
          # Uncomment the following lines to enable TOS as the object store
          # - name: STORAGE_TOS_ACCESS_KEY
          #   valueFrom:
          #   secretKeyRef:
          #     name: aibrix-tos-credentials
          #     key: access-key
          # - name: STORAGE_TOS_SECRET_KEY
          #   valueFrom:
          #     secretKeyRef:
          #       name: aibrix-tos-credentials
          #       key: secret-key
          # - name: STORAGE_TOS_ENDPOINT
          #   valueFrom:
          #     secretKeyRef:
          #       name: aibrix-tos-credentials
          #       key: endpoint
          # - name: STORAGE_TOS_REGION
          #   valueFrom:
          #     secretKeyRef:
          #       name: aibrix-tos-credentials
          #       key: region
          # - name: STORAGE_TOS_BUCKET
          #   valueFrom:
          #     secretKeyRef:
          #       name: aibrix-tos-credentials
          #       key: bucket-name