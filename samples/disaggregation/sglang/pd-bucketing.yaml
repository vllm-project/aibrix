apiVersion: orchestration.aibrix.ai/v1alpha1
kind: StormService
metadata:
  name: sglang-qwen3-8b-1p1d-0-2k
spec:
  replicas: 1
  updateStrategy:
    type: InPlaceUpdate
  stateful: true
  selector:
    matchLabels:
      app: sglang-qwen3-8b-1p1d-0-2k
  template:
    metadata:
      labels:
        app: sglang-qwen3-8b-1p1d-0-2k
    spec:
      roles:
        - name: prefill
          replicas: 1
          stateful: true
          template:
            metadata:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "30000"
                prometheus.io/path: "/metrics"
              labels:
                model.aibrix.ai/name: qwen3-8B
                model.aibrix.ai/port: "30000"
                model.aibrix.ai/metric-port: "30000"
                model.aibrix.ai/engine: sglang
                prompt-min-length: "0"
                prompt-max-length: "2048"
            spec:
              nodeSelector:
                kubernetes.io/hostname: 10.0.151.187
              containers:
                - name: prefill
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/sglang:v0.5.7-mooncake
                  command: ["sh", "-c"]
                  args:
                    - |
                      python3 -m sglang.launch_server \
                        --model-path /models/Qwen3-8B \
                        --served-model-name qwen3-8B \
                        --log-level info \
                        --host 0.0.0.0 \
                        --port 30000 \
                        --disaggregation-mode prefill \
                        --disaggregation-transfer-backend=mooncake \
                        --trust-remote-code \
                        --mem-fraction-static 0.8 \
                        --tp-size 1 \
                        --page-size 64 \
                        --attention-backend fa3 \
                        --reasoning-parser qwen3 \
                        --enable-metrics
                  env:
                    - name: UCX_TLS
                      value: "^gga"
                    - name: GLOO_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_IB_DISABLE
                      value: "0"
                    - name: NCCL_IB_GID_INDEX
                      value: "7"
                    - name: NCCL_DEBUG
                      value: "WARN"
                    - name: PYTHONHASHSEED
                      value: "1047"
                    - name: UCX_PROTO_INFO
                      value: "y"
                    - name: UCX_LOG_LEVEL
                      value: info
                    - name: NIXL_LOG_LEVEL
                      value: info
                    - name: CUDA_VISIBLE_DEVICES
                      value: "0,1,2,3"
                  ports:
                    - containerPort: 30000
                      protocol: TCP
                      name: engine
                  # readinessProbe:
                  #   failureThreshold: 5
                  #   httpGet:
                  #     path: /health
                  #     port: engine
                  #     scheme: HTTP
                  #   initialDelaySeconds: 60
                  #   periodSeconds: 10
                  #   successThreshold: 3
                  #   timeoutSeconds: 5
                  volumeMounts:
                    - name: model-vol
                      mountPath: /models
                    - mountPath: /dev/shm
                      name: shared-mem
                  resources:
                    limits:
                      nvidia.com/gpu: 1
                  securityContext:
                    capabilities:
                      add:
                        - IPC_LOCK
              initContainers:
                - name: init-model
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.1
                  command:
                    - aibrix_download
                    - --model-uri
                    - tos://aibrix-artifact-testing/models/Qwen3-8B/
                    - --local-dir
                    - /models/
                  env:
                    - name: DOWNLOADER_MODEL_NAME
                      value: Qwen3-8B
                    - name: DOWNLOADER_NUM_THREADS
                      value: "16"
                    - name: DOWNLOADER_ALLOW_FILE_SUFFIX
                      value: json, safetensors, bin, py
                    - name: TOS_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_ACCESS_KEY
                    - name: TOS_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_SECRET_KEY
                    - name: TOS_ENDPOINT
                      value: https://tos-s3-cn-beijing.volces.com
                    - name: TOS_REGION
                      value: cn-beijing
                  volumeMounts:
                    - mountPath: /models
                      name: model-vol
              volumes:
                - name: model-vol
                  hostPath:
                    path: /data01/models
                    type: Directory
                - emptyDir:
                    medium: Memory
                  name: shared-mem
        - name: decode
          replicas: 1
          stateful: true
          template:
            metadata:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "30000"
                prometheus.io/path: "/metrics"
              labels:
                model.aibrix.ai/name: qwen3-8B
                model.aibrix.ai/port: "30000"
                model.aibrix.ai/metric-port: "30000"
                model.aibrix.ai/engine: sglang
                prompt-min-length: "0"
                prompt-max-length: "2048"
            spec:
              nodeSelector:
                kubernetes.io/hostname: 10.0.151.187
              containers:
                - name: decode
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/sglang:v0.5.7-mooncake
                  command: ["sh", "-c"]
                  args:
                    - |
                      python3 -m sglang.launch_server \
                        --model-path /models/Qwen3-8B \
                        --served-model-name qwen3-8B \
                        --log-level info \
                        --host 0.0.0.0 \
                        --port 30000 \
                        --disaggregation-mode decode \
                        --disaggregation-transfer-backend=mooncake \
                        --trust-remote-code \
                        --mem-fraction-static 0.8 \
                        --tp-size 1 \
                        --page-size 64 \
                        --attention-backend fa3 \
                        --reasoning-parser qwen3 \
                        --enable-metrics
                  env:
                    - name: UCX_TLS
                      value: "^gga"
                    - name: GLOO_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_IB_DISABLE
                      value: "0"
                    - name: NCCL_IB_GID_INDEX
                      value: "7"
                    - name: NCCL_DEBUG
                      value: "WARN"
                    - name: PYTHONHASHSEED
                      value: "1047"
                    - name: UCX_PROTO_INFO
                      value: "y"
                    - name: UCX_LOG_LEVEL
                      value: info
                    - name: NIXL_LOG_LEVEL
                      value: info
                    - name: CUDA_VISIBLE_DEVICES
                      value: "0,1,2,3,4,5,6,7"
                  ports:
                    - containerPort: 30000
                      protocol: TCP
                      name: engine
                  # readinessProbe:
                  #   failureThreshold: 5
                  #   httpGet:
                  #     path: /health
                  #     port: engine
                  #     scheme: HTTP
                  #   initialDelaySeconds: 60
                  #   periodSeconds: 10
                  #   successThreshold: 3
                  #   timeoutSeconds: 5
                  volumeMounts:
                    - name: model-vol
                      mountPath: /models
                    - mountPath: /dev/shm
                      name: shared-mem
                  resources:
                    limits:
                      nvidia.com/gpu: 1
                  securityContext:
                    capabilities:
                      add:
                        - IPC_LOCK
              initContainers:
                - name: init-model
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.1
                  command:
                    - aibrix_download
                    - --model-uri
                    - tos://aibrix-artifact-testing/models/Qwen3-8B/
                    - --local-dir
                    - /models/
                  env:
                    - name: DOWNLOADER_MODEL_NAME
                      value: Qwen3-8B
                    - name: DOWNLOADER_NUM_THREADS
                      value: "16"
                    - name: DOWNLOADER_ALLOW_FILE_SUFFIX
                      value: json, safetensors, bin, py
                    - name: TOS_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_ACCESS_KEY
                    - name: TOS_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_SECRET_KEY
                    - name: TOS_ENDPOINT
                      value: https://tos-s3-cn-beijing.volces.com
                    - name: TOS_REGION
                      value: cn-beijing
                  volumeMounts:
                    - mountPath: /models
                      name: model-vol
              volumes:
                - name: model-vol
                  hostPath:
                    path: /data01/models
                    type: Directory
                - emptyDir:
                    medium: Memory
                  name: shared-mem
---
apiVersion: orchestration.aibrix.ai/v1alpha1
kind: StormService
metadata:
  name: sglang-qwen3-8b-1p1d-2k-4k
spec:
  replicas: 1
  updateStrategy:
    type: InPlaceUpdate
  stateful: true
  selector:
    matchLabels:
      app: sglang-qwen3-8b-1p1d-2k-4k
  template:
    metadata:
      labels:
        app: sglang-qwen3-8b-1p1d-2k-4k
    spec:
      roles:
        - name: prefill
          replicas: 1
          stateful: true
          template:
            metadata:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "30000"
                prometheus.io/path: "/metrics"
              labels:
                model.aibrix.ai/name: qwen3-8B
                model.aibrix.ai/port: "30000"
                model.aibrix.ai/metric-port: "30000"
                model.aibrix.ai/engine: sglang
                prompt-min-length: "2049"
                prompt-max-length: "4096"
            spec:
              nodeSelector:
                kubernetes.io/hostname: 10.0.151.187
              containers:
                - name: prefill
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/sglang:v0.5.7-mooncake
                  command: ["sh", "-c"]
                  args:
                    - |
                      python3 -m sglang.launch_server \
                        --model-path /models/Qwen3-8B \
                        --served-model-name qwen3-8B \
                        --log-level info \
                        --host 0.0.0.0 \
                        --port 30000 \
                        --disaggregation-mode prefill \
                        --disaggregation-transfer-backend=mooncake \
                        --trust-remote-code \
                        --mem-fraction-static 0.8 \
                        --tp-size 1 \
                        --page-size 64 \
                        --attention-backend fa3 \
                        --reasoning-parser qwen3 \
                        --enable-metrics
                  env:
                    - name: UCX_TLS
                      value: "^gga"
                    - name: GLOO_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_IB_DISABLE
                      value: "0"
                    - name: NCCL_IB_GID_INDEX
                      value: "7"
                    - name: NCCL_DEBUG
                      value: "WARN"
                    - name: PYTHONHASHSEED
                      value: "1047"
                    - name: UCX_PROTO_INFO
                      value: "y"
                    - name: UCX_LOG_LEVEL
                      value: info
                    - name: NIXL_LOG_LEVEL
                      value: info
                    - name: CUDA_VISIBLE_DEVICES
                      value: "0,1,2,3"
                  ports:
                    - containerPort: 30000
                      protocol: TCP
                      name: engine
                  # readinessProbe:
                  #   failureThreshold: 5
                  #   httpGet:
                  #     path: /health
                  #     port: engine
                  #     scheme: HTTP
                  #   initialDelaySeconds: 60
                  #   periodSeconds: 10
                  #   successThreshold: 3
                  #   timeoutSeconds: 5
                  volumeMounts:
                    - name: model-vol
                      mountPath: /models
                    - mountPath: /dev/shm
                      name: shared-mem
                  resources:
                    limits:
                      nvidia.com/gpu: 1
                  securityContext:
                    capabilities:
                      add:
                        - IPC_LOCK
              initContainers:
                - name: init-model
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.1
                  command:
                    - aibrix_download
                    - --model-uri
                    - tos://aibrix-artifact-testing/models/Qwen3-8B/
                    - --local-dir
                    - /models/
                  env:
                    - name: DOWNLOADER_MODEL_NAME
                      value: Qwen3-8B
                    - name: DOWNLOADER_NUM_THREADS
                      value: "16"
                    - name: DOWNLOADER_ALLOW_FILE_SUFFIX
                      value: json, safetensors, bin, py
                    - name: TOS_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_ACCESS_KEY
                    - name: TOS_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_SECRET_KEY
                    - name: TOS_ENDPOINT
                      value: https://tos-s3-cn-beijing.volces.com
                    - name: TOS_REGION
                      value: cn-beijing
                  volumeMounts:
                    - mountPath: /models
                      name: model-vol
              volumes:
                - name: model-vol
                  hostPath:
                    path: /data01/models
                    type: Directory
                - emptyDir:
                    medium: Memory
                  name: shared-mem
        - name: decode
          replicas: 1
          stateful: true
          template:
            metadata:
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "30000"
                prometheus.io/path: "/metrics"
              labels:
                model.aibrix.ai/name: qwen3-8B
                model.aibrix.ai/port: "30000"
                model.aibrix.ai/metric-port: "30000"
                model.aibrix.ai/engine: sglang
                prompt-min-length: "2049"
                prompt-max-length: "4096"
            spec:
              nodeSelector:
                kubernetes.io/hostname: 10.0.151.187
              containers:
                - name: decode
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/sglang:v0.5.7-mooncake
                  command: ["sh", "-c"]
                  args:
                    - |
                      python3 -m sglang.launch_server \
                        --model-path /models/Qwen3-8B \
                        --served-model-name qwen3-8B \
                        --log-level info \
                        --host 0.0.0.0 \
                        --port 30000 \
                        --disaggregation-mode decode \
                        --disaggregation-transfer-backend=mooncake \
                        --trust-remote-code \
                        --mem-fraction-static 0.8 \
                        --tp-size 1 \
                        --page-size 64 \
                        --attention-backend fa3 \
                        --reasoning-parser qwen3 \
                        --enable-metrics
                  env:
                    - name: UCX_TLS
                      value: "^gga"
                    - name: GLOO_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_IB_DISABLE
                      value: "0"
                    - name: NCCL_IB_GID_INDEX
                      value: "7"
                    - name: NCCL_DEBUG
                      value: "WARN"
                    - name: PYTHONHASHSEED
                      value: "1047"
                    - name: UCX_PROTO_INFO
                      value: "y"
                    - name: UCX_LOG_LEVEL
                      value: info
                    - name: NIXL_LOG_LEVEL
                      value: info
                    - name: CUDA_VISIBLE_DEVICES
                      value: "0,1,2,3,4,5,6,7"
                  ports:
                    - containerPort: 30000
                      protocol: TCP
                      name: engine
                  # readinessProbe:
                  #   failureThreshold: 5
                  #   httpGet:
                  #     path: /health
                  #     port: engine
                  #     scheme: HTTP
                  #   initialDelaySeconds: 60
                  #   periodSeconds: 10
                  #   successThreshold: 3
                  #   timeoutSeconds: 5
                  volumeMounts:
                    - name: model-vol
                      mountPath: /models
                    - mountPath: /dev/shm
                      name: shared-mem
                  resources:
                    limits:
                      nvidia.com/gpu: 1
                  securityContext:
                    capabilities:
                      add:
                        - IPC_LOCK
              initContainers:
                - name: init-model
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.1
                  command:
                    - aibrix_download
                    - --model-uri
                    - tos://aibrix-artifact-testing/models/Qwen3-8B/
                    - --local-dir
                    - /models/
                  env:
                    - name: DOWNLOADER_MODEL_NAME
                      value: Qwen3-8B
                    - name: DOWNLOADER_NUM_THREADS
                      value: "16"
                    - name: DOWNLOADER_ALLOW_FILE_SUFFIX
                      value: json, safetensors, bin, py
                    - name: TOS_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_ACCESS_KEY
                    - name: TOS_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_SECRET_KEY
                    - name: TOS_ENDPOINT
                      value: https://tos-s3-cn-beijing.volces.com
                    - name: TOS_REGION
                      value: cn-beijing
                  volumeMounts:
                    - mountPath: /models
                      name: model-vol
              volumes:
                - name: model-vol
                  hostPath:
                    path: /data01/models
                    type: Directory
                - emptyDir:
                    medium: Memory
                  name: shared-mem
---
apiVersion: orchestration.aibrix.ai/v1alpha1
kind: StormService
metadata:
  name: sglang-qwen3-8b-combined
spec:
  replicas: 1
  updateStrategy:
    type: InPlaceUpdate
  stateful: true
  selector:
    matchLabels:
      app: sglang-qwen3-8b-combined
  template:
    metadata:
      labels:
        app: sglang-qwen3-8b-combined
    spec:
      roles:
        - name: all
          replicas: 1
          stateful: true
          template:
            metadata:
              annotations:
                annotations:
                prometheus.io/scrape: "true"
                prometheus.io/port: "30000"
                prometheus.io/path: "/metrics"
              labels:
                model.aibrix.ai/name: qwen3-8B
                model.aibrix.ai/port: "30000"
                model.aibrix.ai/metric-port: "30000"
                model.aibrix.ai/engine: sglang
                prompt-min-length: "0"
                model.aibrix.ai/combined: "true"
            spec:
              nodeSelector:
                kubernetes.io/hostname: 10.1.9.155
              containers:
                - name: combined
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/sglang:v0.5.7-mooncake
                  command: ["sh", "-c"]
                  args:
                    - |
                      python3 -m sglang.launch_server \
                        --model-path /models/Qwen3-8B \
                        --served-model-name qwen3-8B \
                        --log-level info \
                        --host 0.0.0.0 \
                        --port 30000 \
                        --trust-remote-code \
                        --mem-fraction-static 0.8 \
                        --tp-size 1 \
                        --page-size 64 \
                        --attention-backend fa3 \
                        --reasoning-parser qwen3 \
                        --enable-metrics
                  env:
                    - name: UCX_TLS
                      value: "^gga"
                    - name: GLOO_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_SOCKET_IFNAME
                      value: "eth0"
                    - name: NCCL_IB_DISABLE
                      value: "0"
                    - name: NCCL_IB_GID_INDEX
                      value: "7"
                    - name: NCCL_DEBUG
                      value: "WARN"
                    - name: PYTHONHASHSEED
                      value: "1047"
                    - name: UCX_PROTO_INFO
                      value: "y"
                    - name: UCX_LOG_LEVEL
                      value: info
                    - name: NIXL_LOG_LEVEL
                      value: info
                    - name: CUDA_VISIBLE_DEVICES
                      value: "0,1,2,3"
                  ports:
                    - containerPort: 30000
                      protocol: TCP
                      name: engine
                  # readinessProbe:
                  #   failureThreshold: 5
                  #   httpGet:
                  #     path: /health
                  #     port: engine
                  #     scheme: HTTP
                  #   initialDelaySeconds: 60
                  #   periodSeconds: 10
                  #   successThreshold: 3
                  #   timeoutSeconds: 5
                  volumeMounts:
                    - name: model-vol
                      mountPath: /models
                    - mountPath: /dev/shm
                      name: shared-mem
                  resources:
                    limits:
                      nvidia.com/gpu: 1
                  securityContext:
                    capabilities:
                      add:
                        - IPC_LOCK
              initContainers:
                - name: init-model
                  image: aibrix-container-registry-cn-beijing.cr.volces.com/aibrix/runtime:v0.2.1
                  command:
                    - aibrix_download
                    - --model-uri
                    - tos://aibrix-artifact-testing/models/Qwen3-8B/
                    - --local-dir
                    - /models/
                  env:
                    - name: DOWNLOADER_MODEL_NAME
                      value: Qwen3-8B
                    - name: DOWNLOADER_NUM_THREADS
                      value: "16"
                    - name: DOWNLOADER_ALLOW_FILE_SUFFIX
                      value: json, safetensors, bin, py
                    - name: TOS_ACCESS_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_ACCESS_KEY
                    - name: TOS_SECRET_KEY
                      valueFrom:
                        secretKeyRef:
                          name: aibrix-tos-credential
                          key: TOS_SECRET_KEY
                    - name: TOS_ENDPOINT
                      value: https://tos-s3-cn-beijing.volces.com
                    - name: TOS_REGION
                      value: cn-beijing
                  volumeMounts:
                    - mountPath: /models
                      name: model-vol
              volumes:
                - name: model-vol
                  hostPath:
                    path: /data01/models
                    type: Directory
                - emptyDir:
                    medium: Memory
                  name: shared-mem
