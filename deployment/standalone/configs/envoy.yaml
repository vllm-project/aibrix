# AIBrix Envoy Configuration with Gateway Plugin (ext_proc)
#
# This configuration provides intelligent routing through the gateway-plugin:
# - Request parsing and model extraction
# - Routing algorithms (least_request, prefix_cache_aware, etc.)
# - Rate limiting and authentication
# - Request/response metrics
#
# The gateway-plugin acts as an External Processor (ext_proc) that:
# 1. Receives request headers and body from Envoy
# 2. Extracts model name and routing information
# 3. Selects the best backend based on routing algorithm
# 4. Returns the target backend via the "target-pod" header
# 5. Envoy routes to the selected backend

admin:
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
  access_log:
    - name: envoy.access_loggers.stdout
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

static_resources:
  listeners:
    - name: http_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 80
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO

                # Enable streaming for LLM responses
                stream_idle_timeout: 300s
                request_timeout: 600s

                access_log:
                  - name: envoy.access_loggers.stdout
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                      log_format:
                        text_format: "[%START_TIME%] \"%REQ(:METHOD)% %REQ(:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% \"%REQ(X-REQUEST-ID)%\" \"%UPSTREAM_HOST%\"\n"

                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: aibrix_api
                      domains: ["*"]
                      routes:
                        # ============================================
                        # Inference Endpoints - Routed via Gateway
                        # ============================================

                        - match:
                            prefix: "/v1/chat/completions"
                          route:
                            cluster: vllm_backend
                            timeout: 600s
                            idle_timeout: 300s

                        - match:
                            prefix: "/v1/completions"
                          route:
                            cluster: vllm_backend
                            timeout: 600s
                            idle_timeout: 300s

                        - match:
                            prefix: "/v1/embeddings"
                          route:
                            cluster: vllm_backend
                            timeout: 120s

                        # ============================================
                        # Metadata Service - Direct routing
                        # ============================================

                        - match:
                            prefix: "/v1/models"
                          route:
                            cluster: metadata_service
                            timeout: 30s

                        - match:
                            prefix: "/v1/files"
                          route:
                            cluster: metadata_service
                            timeout: 120s

                        - match:
                            prefix: "/v1/batches"
                          route:
                            cluster: metadata_service
                            timeout: 30s

                        # ============================================
                        # Health & Monitoring
                        # ============================================

                        - match:
                            prefix: "/health"
                          route:
                            cluster: vllm_backend
                            timeout: 10s

                        - match:
                            prefix: "/healthz"
                          direct_response:
                            status: 200
                            body:
                              inline_string: '{"status":"ok","mode":"gateway"}'

                        - match:
                            prefix: "/metrics"
                          route:
                            cluster: gateway_metrics
                            timeout: 10s

                        - match:
                            prefix: "/v1/"
                          route:
                            cluster: vllm_backend
                            timeout: 120s

                        - match:
                            prefix: "/"
                          direct_response:
                            status: 404
                            body:
                              inline_string: '{"error":"Not Found","message":"Use /v1/chat/completions, /v1/models, or /health"}'

                http_filters:
                  # ============================================
                  # External Processor - Gateway Plugin
                  # ============================================
                  - name: envoy.filters.http.ext_proc
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                      grpc_service:
                        envoy_grpc:
                          cluster_name: gateway_ext_proc
                        timeout: 30s
                      processing_mode:
                        request_header_mode: SEND
                        request_body_mode: BUFFERED
                        response_header_mode: SEND
                        response_body_mode: STREAMED
                        request_trailer_mode: SKIP
                        response_trailer_mode: SKIP
                      message_timeout: 30s
                      failure_mode_allow: false
                      # Only process inference endpoints
                      filter_metadata:
                        envoy.filters.http.ext_proc:
                          skip_non_inference: true

                  - name: envoy.filters.http.request_id
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.request_id.v3.RequestIDConfig
                      pack_trace_reason: false

                  - name: envoy.filters.http.cors
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors

                  - name: envoy.filters.http.health_check
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
                      pass_through_mode: false
                      headers:
                        - name: ":path"
                          string_match:
                            exact: "/envoy-health"

                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # ============================================
    # Gateway Plugin (ext_proc)
    # ============================================

    - name: gateway_ext_proc
      type: STRICT_DNS
      dns_lookup_family: V4_ONLY
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}
      load_assignment:
        cluster_name: gateway_ext_proc
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: gateway
                      port_value: 50052
      health_checks:
        - timeout: 5s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          grpc_health_check: {}
      connect_timeout: 5s

    # ============================================
    # Gateway Metrics
    # ============================================

    - name: gateway_metrics
      type: STRICT_DNS
      dns_lookup_family: V4_ONLY
      load_assignment:
        cluster_name: gateway_metrics
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: gateway
                      port_value: 8080
      connect_timeout: 5s

    # ============================================
    # vLLM Backend
    # ============================================

    - name: vllm_backend
      type: STRICT_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN

      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http_protocol_options:
              enable_trailers: true

      load_assignment:
        cluster_name: vllm_backend
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: vllm
                      port_value: 8000

      health_checks:
        - timeout: 10s
          interval: 30s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: /health

      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 1000
            max_pending_requests: 1000
            max_requests: 1000
            max_retries: 3

      connect_timeout: 30s

      outlier_detection:
        consecutive_5xx: 5
        interval: 30s
        base_ejection_time: 60s
        max_ejection_percent: 50

    # ============================================
    # Metadata Service
    # ============================================

    - name: metadata_service
      type: STRICT_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN

      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http_protocol_options: {}

      load_assignment:
        cluster_name: metadata_service
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: metadata-service
                      port_value: 8090

      health_checks:
        - timeout: 5s
          interval: 10s
          unhealthy_threshold: 3
          healthy_threshold: 1
          http_health_check:
            path: /healthz

      connect_timeout: 5s

      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 100
            max_pending_requests: 100
            max_requests: 100
