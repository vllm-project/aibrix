{{- if .Values.gateway.enable }}
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: {{ include "aibrix.fullname" . }}-eg
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
  parametersRef:
    group: gateway.envoyproxy.io
    kind: EnvoyProxy
    name: {{ include "aibrix.fullname" . }}-custom-proxy-config
    namespace: {{ .Release.Namespace }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ include "aibrix.fullname" . }}-eg
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway
spec:
  gatewayClassName: {{ include "aibrix.fullname" . }}-eg
  listeners:
    - name: http
      protocol: HTTP
      port: 80
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: {{ include "aibrix.fullname" . }}-custom-proxy-config
spec:
  provider:
    type: Kubernetes
    kubernetes:
      envoyDeployment:
        replicas:  {{ .Values.gateway.envoyProxy.replicas }}
        strategy:
          type: RollingUpdate
          rollingUpdate:
            maxUnavailable: 1
            maxSurge: 1
        pod:
          {{- with .Values.gateway.envoyProxy.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.gateway.envoyProxy.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        patch:
          type: StrategicMerge
          value:
            spec:
              template:
                metadata:
                  labels:
                    app.kubernetes.io/name: envoy
                    app.kubernetes.io/component: proxy
                spec:
                  {{- include "aibrix.imagePullSecrets" (dict "componentSecrets" .Values.gateway.envoyProxy.imagePullSecrets "globalSecrets" .Values.global.imagePullSecrets) | nindent 18 }}
                  containers:
                    - name: envoy
                      image: {{ .Values.gateway.envoyProxy.container.envoy.image }}
                      resources: {{ toYaml .Values.gateway.envoyProxy.container.envoy.resources | nindent 24 }}
                    - name: shutdown-manager
                      image: {{ .Values.gateway.envoyProxy.container.shutdownManager.image }}
                      resources: {{ toYaml .Values.gateway.envoyProxy.container.shutdownManager.resources | nindent 24 }}
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: ClientTrafficPolicy
metadata:
  name: {{ include "aibrix.fullname" . }}-client-connection-buffersize
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: {{ include "aibrix.fullname" . }}-eg
  connection:
    bufferLimit: {{ .Values.gateway.clientTrafficPolicy.connection.bufferLimit }}
    connectionLimit:
      value: {{ .Values.gateway.clientTrafficPolicy.connection.connectionLimit.value }}
  http2:
    maxConcurrentStreams: {{ .Values.gateway.clientTrafficPolicy.http2.maxConcurrentStreams }}
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: {{ include "aibrix.fullname" . }}-backend-connection-policy
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: {{ include "aibrix.fullname" . }}-eg
  circuitBreaker:
    maxConnections: {{ .Values.gateway.backendTrafficPolicy.circuitBreaker.maxConnections }}
    maxParallelRequests: {{ .Values.gateway.backendTrafficPolicy.circuitBreaker.maxParallelRequests }}
    maxParallelRetries: {{ .Values.gateway.backendTrafficPolicy.circuitBreaker.maxParallelRetries }}
    maxPendingRequests: {{ .Values.gateway.backendTrafficPolicy.circuitBreaker.maxPendingRequests }}
    maxRequestsPerConnection: {{ .Values.gateway.backendTrafficPolicy.circuitBreaker.maxRequestsPerConnection }}
  http2:
    maxConcurrentStreams: {{ .Values.gateway.backendTrafficPolicy.http2.maxConcurrentStreams }}
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: {{ include "aibrix.fullname" . }}-epp
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway
spec:
  type: "JSONPatch"
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: {{ include "aibrix.fullname" . }}-eg
  jsonPatches:
    - type: type.googleapis.com/envoy.config.route.v3.RouteConfiguration
      name: {{ .Release.Namespace }}/{{ include "aibrix.fullname" . }}-eg/http
      operation:
        op: add
        path: "/virtual_hosts/0/routes/0"
        value:
          name: original_route
          match:
            prefix: "/"
            headers:
              - name: "routing-strategy"
                string_match:
                  safe_regex:
                    regex: ".*"
          route:
            cluster: original_destination_cluster
            timeout: {{ .Values.gateway.envoyPatchPolicy.route.timeout }}
          typed_per_filter_config:
            "envoy.filters.http.ext_proc/envoyextensionpolicy/{{ .Release.Namespace }}/aibrix-gateway-plugins-extension-policy/extproc/0":
              "@type": "type.googleapis.com/envoy.config.route.v3.FilterConfig"
              config: {}
    - type: "type.googleapis.com/envoy.config.cluster.v3.Cluster"
      name: "envoy-patch-policy-override2"
      operation:
        op: add
        path: ""
        value:
          name: original_destination_cluster
          type: ORIGINAL_DST
          original_dst_lb_config:
            use_http_header: true
            http_header_name: "target-pod"
          connect_timeout: {{ .Values.gateway.envoyPatchPolicy.route.connectTimeout }}
          lb_policy: CLUSTER_PROVIDED
          dns_lookup_family: V4_ONLY
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: {{ .Values.gateway.envoyPatchPolicy.circuitBreakers.maxConnections }}
                max_requests: {{ .Values.gateway.envoyPatchPolicy.circuitBreakers.maxRequests }}
                max_pending_requests: {{ .Values.gateway.envoyPatchPolicy.circuitBreakers.maxPendingRequests }}
{{- end }}
