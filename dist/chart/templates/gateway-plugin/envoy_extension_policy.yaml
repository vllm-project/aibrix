# templates/envoy-extension-policy.yaml
{{- if .Values.gateway.enable }}
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: {{ include "aibrix.fullname" . }}-gateway-plugins-extension-policy
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway-plugin
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "aibrix.fullname" . }}-reserved-router
  extProc:
    - backendRefs:
        - name: {{ include "aibrix.fullname" . }}-gateway-plugins
          port: 50052
      processingMode:
        request:
          body: Buffered
        response:
          body: Streamed
      messageTimeout: {{ .Values.gatewayPlugin.messageTimeout }}
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: {{ include "aibrix.fullname" . }}-skip-ext-proc
  labels:
    {{- include "aibrix.labels" . | nindent 4 }}
    app.kubernetes.io/component: aibrix-gateway-plugin
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ include "aibrix.fullname" . }}-reserved-router-metadata-endpoint
{{- end }}
