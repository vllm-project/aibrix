# [Core]: AIBrix Deployment Configurations
nameOverride: ""
fullnameOverride: ""

global:
  imagePullSecrets: []

controllerManager:
  replicas: 1
  imagePullSecrets: []
  container:
    image:
      repository: aibrix/controller-manager
      tag: nightly
      imagePullPolicy: IfNotPresent
    resources:
      limits:
        cpu: 500m
        memory: 128Mi
      requests:
        cpu: 10m
        memory: 64Mi
    probes:
      liveness:
        httpGet:
          path: /healthz
          port: 8081
        initialDelaySeconds: 15
        periodSeconds: 20
      readiness:
        httpGet:
          path: /readyz
          port: 8081
        initialDelaySeconds: 5
        periodSeconds: 10
  gatewayTimeoutSeconds: 120
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  tolerations: []
  affinity: {}

gatewayPlugin:
  replicaCount: 1
  imagePullSecrets: []
  initContainer:
    image:
      repository: busybox
      tag: stable
  container:
    image:
      repository: aibrix/gateway-plugins
      tag: nightly
      imagePullPolicy: IfNotPresent
    resources:
      limits:
        cpu: "1"
        memory: 1Gi
      requests:
        cpu: "1"
        memory: 1Gi
    probes:
      liveness:
        grpc:
          port: 50052
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 3
        failureThreshold: 3
      readiness:
        grpc:
          port: 50052
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 3
        failureThreshold: 3
    envs:
      AIBRIX_POD_METRIC_REFRESH_INTERVAL_MS: "50"
      AIBRIX_PREFIX_CACHE_TOKENIZER_TYPE: "character"
      AIBRIX_PREFIX_CACHE_BLOCK_SIZE: "128"
      AIBRIX_PREFIX_CACHE_POD_RUNNING_REQUEST_IMBALANCE_ABS_COUNT: "16"
      AIBRIX_PREFIX_CACHE_STANDARD_DEVIATION_FACTOR: "2"
      AIBRIX_PREFILL_REQUEST_TIMEOUT: "60"
  dependencies:
    redis:
      host: "" # aibrix-redis-master
      port: 6379
  messageTimeout: "60s"
  extProc:
    backendSettings:
      circuitBreaker:
        # The maximum number of connections that Envoy will establish to the external processing service.
        maxConnections: 1024
        # The maximum number of parallel requests that Envoy will make to the external processing service.
        maxParallelRequests: 1024
        # The maximum number of pending requests that Envoy will allow to the external processing service.
        maxPendingRequests: 1024
        # The maximum number of parallel retries that Envoy will allow to the external processing service.
        maxParallelRetries: 1024
        # The maximum number of requests that can be served through one connection to the external processing service.
        maxRequestsPerConnection: 1024
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  tolerations: []

gpuOptimizer:
  replicaCount: 1
  imagePullSecrets: []
  container:
    image:
      repository: aibrix/metadata-service
      tag: nightly
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 10m
        memory: 64Mi
  dependencies:
    redis:
      host: ""  # aibrix-redis-master
      port: 6379
  tolerations: []
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  affinity: {}

gateway:
  enable: true
  envoyProxy:
    replicas: 1
    imagePullSecrets: []
    tolerations: []
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - envoy
              topologyKey: "kubernetes.io/hostname"
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: nvidia.com/gpu.present
                  operator: NotIn
                  values:
                    - "true"
    container:
      envoy:
        image: envoyproxy/envoy:v1.33.2
        resources:
          requests:
            cpu: "1"
            memory: 1Gi
          limits:
            cpu: "1"
            memory: 1Gi
      shutdownManager:
        image: envoyproxy/gateway:v1.2.8
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
    service: null
  clientTrafficPolicy:
    connection:
      bufferLimit: 4194304  # 4MiB
      connectionLimit:
        value: 1024
    http2:
      maxConcurrentStreams: 1024
  backendTrafficPolicy:
    circuitBreaker:
      # The maximum number of connections to a backend pod.
      maxConnections: 1024
      # The maximum number of parallel requests to a backend pod.
      maxParallelRequests: 1024
      # The maximum number of parallel retries to a backend pod.
      maxParallelRetries: 1024
      # The maximum number of pending requests to a backend pod.
      maxPendingRequests: 1024
      # The maximum number of requests that can be served through one connection to a backend pod.
      maxRequestsPerConnection: 1024
    http2:
      # The maximum number of concurrent streams for an HTTP/2 connection to a backend pod.
      maxConcurrentStreams: 1024
  envoyPatchPolicy:
    route:
      timeout: 120s          # e.g., "120s" or "2m"
      connectTimeout: 6s     # e.g., "6s"
    circuitBreakers:
      # The maximum number of connections for the original destination cluster.
      maxConnections: 1024
      # The maximum number of requests that can be outstanding to the original destination cluster.
      maxRequests: 1024
      # The maximum number of pending requests to the original destination cluster.
      maxPendingRequests: 1024

metadata:
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  service:
    replicas: 1
    imagePullSecrets: []
    initContainer:
      image:
        repository: busybox
        tag: stable
    container:
      image:
        repository: aibrix/metadata-service
        tag: nightly
        imagePullPolicy: IfNotPresent
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 50m
          memory: 128Mi
    tolerations: []
    affinity: {}
    redis:
      host: "" # aibrix-redis-master
      port: 6379
  redis:
    replicas: 1
    imagePullSecrets: []
    container:
      image:
        repository: redis
        tag: "7.4"
      resources:
        requests:
          cpu: 100m
          memory: 100Mi
    enablePassword: false
    password: ""

# [CRDs]: To enable the CRDs
crd:
  # This option determines whether the CRDs are included
  # in the installation process.
  enable: true

  # Enabling this option adds the "helm.sh/resource-policy": keep
  # annotation to the CRD, ensuring it remains installed even when
  # the Helm release is uninstalled.
  # NOTE: Removing the CRDs will also remove all cert-manager CR(s)
  # (Certificates, Issuers, ...) due to garbage collection.
  keep: true


# [WEBHOOKS]: Webhooks configuration
# The following configuration is automatically generated from the manifests
# generated by controller-gen. To update run 'make manifests' and
# the edit command with the '--force' flag
webhook:
  enable: true

# [PROMETHEUS]: To enable a ServiceMonitor to export metrics to Prometheus set true
prometheus:
  enable: false

# [CERT-MANAGER]: To enable cert-manager injection to webhooks set true
certmanager:
  enable: false


# TODO: manage common labels
# app.kubernetes.io/component: aibrix-controller-manager
# app.kubernetes.io/managed-by: kubectl
# app.kubernetes.io/name: aibrix
# app.kubernetes.io/version: nightly
